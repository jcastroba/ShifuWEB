---
import type { AstroGlobal } from "astro";
import db from "../utils/db.js";
import { getUserFromSession } from "../utils/auth";
import UserDashboard from "./UserDashboard";

// Verifica usuario
const user = await getUserFromSession(Astro as AstroGlobal);
if (!user) {
  throw new Error("No hay usuario autenticado");
}

// Obtener servidores a los que pertenece el usuario
const userServersQuery = `
  SELECT s.id, s.name, s.icon_url
  FROM servers s
  JOIN user_servers us ON s.id = us.server_id
  WHERE us.user_id = $1
`;
const { rows: userServers } = await db.query(userServersQuery, [user.id]);
---

<div class="min-h-[calc(100vh-64px)] bg-background dark:bg-gray-900 transition-colors duration-300">
  <UserDashboard client:load userServers={userServers} />
</div>

<button
  class="fixed bottom-5 right-5 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg z-50 transition-transform hover:scale-110 flex items-center gap-2"
  onclick="window.location.href='/api/download-csv'"
  title="Descargar CSV"
>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
</button>


